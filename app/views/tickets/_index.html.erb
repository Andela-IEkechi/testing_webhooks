<%
  project_id ||= @project && @project.id
  sprint_id ||= @sprint && @sprint.to_param
  feature_id ||= @feature && @feature.to_param

  parent = "sprint-#{sprint_id}" if sprint_id
  parent ||= "feature-#{feature_id}" if feature_id
  parent ||= "project-#{project_id}" if project_id
 %>

 <div id="tickets-list-container-<%= parent %>" <%if params[:hide_empty_tickets] && @tickets.empty? %> data-hide-empty-tickets  style="display:none;" <% end %> >
  <table class="table table-bordered table-striped" id="ticket-list">
    <caption>
      <div class="pull-right">
        <% if @search && @show_search %>
          <%= search_form_for @search,
                url:     project_tickets_path(@project),
                html:    {:method => :get, :class => 'form-search'},
                remote:  true,
                builder: SimpleForm::FormBuilder do |f| %>

            <% # this field can be any valid ransack term as it gets  %>
            <% # overwritten in the backend based on seach type       %>
            <%= f.input_field :title_cont, label: false, placeholder: 'search', value: @term %>

            <%= f.hidden_field :sprint_id, :value => sprint_id %>
            <%= f.hidden_field :feature_id, :value => feature_id %>
            <%= f.hidden_field :project_id, :value => project_id %>
            <%= f.submit 'Search' %>
          <% end %>
        <% end %>
      </div>
      <h4><%= @title || 'Tickets' %></h4>
    </caption>
    <!--title row -->
    <thead>
    <tr>
      <th class="width-5">#</th>
      <th>Title</th>
      <th class="width-15">Feature</th>
      <th class="width-15">Sprint</th>
      <th class="width-15">Assignee</th>
      <th class="width-10">State</th>
      <th class="width-50px">Cost</th>
    </tr>
    </thead>
    <tbody>
    <% @tickets.each do |ticket| %>
    <tr data-state="<%= ticket.status %>" data-search="<%= ticket.filter_summary %>">
      <td><%= ticket.scoped_id %></td>
      <td class="overflow" title="<%= ticket.title %>"><%= link_to ticket.title, project_ticket_path(ticket.project, ticket) %></td>
      <td>
        <div class="overflow" title="<%= ticket.feature %>">
          <%= link_to ticket.feature, project_feature_path(ticket.project, ticket.feature) if ticket.feature %>
        </div>
      </td>
      <td>
        <div class="overflow" title="<%= ticket.sprint %>">
          <%= link_to ticket.sprint, project_sprint_path(ticket.project, ticket.sprint) if ticket.sprint %>
        </div>
      </td>
      <td>
        <div class="overflow" title="<%= assignee(ticket, true) %>">
          <% if ticket.assignee && ticket.assignee.memberships.to_project(ticket.project.id).any? %>
            <%= ticket.assignee(ticket) %>
          <% else %>
            <span class='non-member' title="<%= assignee(ticket, true) %> (not a member)">
              <%= ticket.assignee(ticket) %>
            </span>
          <% end %>
        </div>
      </td>
      <td>
        <div class="overflow" title="<%= ticket.status %>">
          <%= ticket.status %>
        </div>
      </td>
      <td class="count" title="cost of this ticket"><span class="badge badge-warning"><%= cost_short(ticket.cost) %></span></td>
    </tr>
    <% end if @tickets %>
    <% if @tickets && @tickets.count == 0 %>
      <tr>
        <td colspan="7">There are no tickets</td>
      </tr>
    <% end %>
    <% unless @tickets %>
      <tr>
        <td colspan="7">
            <%= ticket_load_link 'loading tickets...', {}, {:class => "autoload"} %>
        </td>
      </tr>
    <% end %>
    <% if @tickets_count %>
      <tr>
        <td colspan="7">
          <span class="pull-right ticket-result-summary">
          <% if @assignees_count > 0 %>
            <%= @assignees_count %> assignees on
          <% else %>
            no assigned tickets
          <% end %>
          <% if @tickets_count %>
            <%= @tickets_count %> tickets
          <% end %>
          <% if @tickets_cost > 0 %>
            @ total cost <%= @tickets_cost %></span>
          <% else %>
            @ unknown cost
          <% end %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>

  <% if @tickets && @tickets.respond_to?(:total_pages) && (@tickets.total_pages > 1) %>
    <%= paginate @tickets,
        :params => {
          :controller => 'tickets',
          :action => 'index',
        }.merge(ticket_url_params),
        :remote => true if @tickets %>
    <%= ticket_load_link 'show all', {:paginate => false} %>
  <% end %>
  <% if @tickets && !@tickets.respond_to?(:total_pages) && (@tickets.count > (current_user.preferences.page_size.to_i)) %>
    <%= ticket_load_link 'show paged' %>
  <% end %>

</div>
