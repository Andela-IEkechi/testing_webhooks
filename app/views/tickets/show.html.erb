<%
  comments = @ticket.comments
  old_comments = []
  if hide_comments?
    comments = comments.last(5)
    old_comments = @ticket.comments[1..-6]
  end
%>

<div class="ticket-title">
  <h1 class="pull-right ">#<%= @ticket.scoped_id %></h1>
  <h3><%= @ticket.title %>&nbsp;<small><%= @ticket.parent %></small></h3>
</div>

<div class="ticket-statusbar">
  <ul class="inline">
    <li><small>state: <b><%= @ticket.status %></b></small></li>
    <% if @ticket.feature %>
    <li><small>feature: <b><%= @ticket.feature || 'none' %></b></small></li>
    <% end %>
    <% if @ticket.sprint %>
    <li><small>sprint: <b><%= @ticket.sprint || 'none' %></b></small></li>
    <% end %>
    <% if @ticket.assignee %>
    <li><small>
      assignee:
      <% if !@ticket.assignee || @ticket.project.memberships.for_user(@ticket.assignee.id).any? %>
      <b><%= @ticket.assignee || 'none' %></b>
      <% else %>
      <span class='non-member' title='not a member'> <%= @ticket.assignee %></span>
      <% end %>
      </small>
    </li>
    <% end %>
    <% if @ticket.cost %>
    <li><small>cost: <b><%= cost_long(@ticket.cost) %></b></small></li>
    <% end %>
    <% if @ticket.assets.any? %>
    <li><small>attachments: <b><%= @ticket.assets.count %> files</b></small></li>
    <% end %>
  </ul>
</div>

<%= render :partial => '/comments/comment', :collection => [@ticket.comments.first] %>

<!-- render older comments if there are any -->
<% if old_comments.any?  %>
  <div class="older_comments" style="display:none;">
    <%= render :partial => '/comments/comment', :collection => old_comments %>
  </div>
  <div class="show-hide-toggle alert alert-info">
    <%= link_to '#', :class => 'hide_older', :style=>"display:none;" do %>
      hide <%= old_comments.count %> older comments <i class='icon-chevron-up'></i>
    <% end %>
    <%= link_to '#', :class => 'show_older' do %>
      show <%= old_comments.count %> older comments <i class='icon-chevron-down'></i>
    <% end %>
  </div>
<% end %>

<%= render :partial => '/comments/comment', :collection => comments %>
<% if current_membership && !current_membership.restricted? %>
  <%= render :partial => '/comments/form' %>
<% end %>
